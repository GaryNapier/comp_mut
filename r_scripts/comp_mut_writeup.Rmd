---
title: "Compensatory mutations in *ahpC* reveal novel *katG* mutations implicated in isoniazid resistance in Mycobacterium tuberculosis"
output: 
  bookdown::word_document2: 
    fig_caption: yes
    table_caption: yes
    number_sections: no
mainfont: Calibri
fontsize: 10pt
bibliography: all_refs.bib
csl: biomed-central.csl
---

```{r setup, include=FALSE, echo = F, warning=F, message=F}

# SETUP ----

rm(list = ls())

knitr::opts_chunk$set(echo = F)
# options(scipen=1, digits=2)
options(scipen=999, digits = 3)
table_font_sz <- 8

```

```{r library, include=FALSE, echo = F, warning=F, message=F}

library(tidyr)
library(dplyr)
library(knitr)
library(reshape2)
library(janitor)

```

```{r functions, echo = F, warning=F, message=F}

source("https://raw.githubusercontent.com/GaryNapier/Packages_functions/master/Functions.R")

uniq_col <- function(x, split = "; "){
  unique(unlist(strsplit(x, split)))
}

col_pc <- function(df, col){
  round((df[, col] / sum(df[, col]))*100, 3)
}

len_uniq <- function(x){
  length(unique(x))
}

rbind_force <- function(df1, df2){
  rbind(df1, setNames(df2, names(df1)))
}

# Make quick pivot table summarising total unique values by column
# my_formula arg must be call to the formula() function: formula(<col> ~ 'n')
# Result:
#             PRM            n
#  katG-c.2223A>G  3   (4.05%)
# katG-p.Arg484His  5   (6.76%)
# ...
# katG-p.Tyr413Cys  8  (10.81%)
#           Total 74 (100.00%)
pivot <- function(x, my_formula, value_var = "wgs_id"){
  drop_cols(to_table(reshape2::dcast(x, my_formula, value.var = value_var, fun.aggregate = len_uniq),
                     pc_dir = 'col'), 
            'Total')
}

duped <- function(x, col){
  dups <- x[duplicated(x[col]), col]
  x[x[, col] %in% dups, ]
}

# Swap first and second parts of string, splitting on a charachter (or substring)
# e.g. 
# x <- "katG-p.Ile335Val; katG-p.Ser315Thr"
# swap_str(x, "; ")
# "katG-p.Ser315Thr; katG-p.Ile335Val"
swap_str <- function(x, split_chr = "; "){
  paste0(unlist(strsplit(x, split_chr))[c(2, 1)], collapse = split_chr)
}


# Print each element of vector vertically instead of across the screen
# e.g. 
# > x <- c("a", "b", "c")
# > x
# [1] "a" "b" "c"
# > print_vert(x)
# a
# b
# c
print_vert <- function(x){
  cat(paste0(x, '\n'))
}

# Remove change from second gene-change pair
# e.g.
# x <- "katG-p.Ser315Thr; fabG1-c.-15C>T"
# > drop_change(x, "-")
# [1] "katG-p.Ser315Thr; fabG1"
drop_change <- function(string, split_on = "-"){
  unlist(lapply(strsplit(string, split_on), function(x){paste0(x[c(1, 2)], collapse = split_on)}))
}

clean_binary_table <- function(x){
  x <- data.frame(apply(x, 2, function(x){gsub("\\[\\]", NA, as.character(x))}))
  x <- data.frame(apply(x, 2, function(x){ gsub("\\[||\\]", "", as.character(x)) }))
  x <- data.frame(apply(x, 2, function(x){ gsub("\\), \\(", "; ", as.character(x)) }))
  x <- data.frame(apply(x, 2, function(x){ gsub("\\', \\'", "-", as.character(x)) }))
  x <- data.frame(apply(x, 2, function(x){ gsub("\\(||\\)", "", as.character(x)) }))
  x <- data.frame(apply(x, 2, function(x){ gsub("\\'", "", as.character(x)) }))
  x
}

sort_pos <- function(df, col){
  mut <- df[, col]
  pos <- sort(as.numeric(stringr::str_extract(mut, "[0-9]+")))
  df[sapply(pos, function(x) grep(x, mut)), ]
}

```

```{r variables, echo = F, warning=F, message=F}


# VARIABLES ----

id_col <- "wgs_id"
rnd <- 3
drugs <- c("rifampicin", "isoniazid", "ethambutol", "pyrazinamide", "streptomycin", 
             "ofloxacin", "moxifloxacin", "levofloxacin", "amikacin", "kanamycin", "capreomycin", "ciprofloxacin", "prothionamide", 
             "ethionamide", "para_aminosalicylic_acid", "cycloserine",
             "clarithromycin", "clofazimine", "bedaquiline", "linezolid", "rifabutin", "delamanid")
fq <- "fluoroquinolones, ofloxacin, levofloxacin, ciprofloxacin, moxifloxacin"
agc <- "capreomycin, streptomycin, amikacin, kanamycin, aminoglycosides"
align <- c("l", "r", "r")
blue_col <- "cornflowerblue"
plot_text_sz <- 0.5
main_cex <- 1.5
# dr_status_vect <- c("Sensitive", "Pre-MDR", "MDR", "Pre-XDR", "XDR", "Other")
dr_status_vect <- c("Sensitive", "Pre-MDR-TB", "HR-TB", "RR-TB", "MDR-TB", "Pre-XDR-TB", "XDR-TB", "Other")

```

```{r paths, echo = F, warning=F, message=F}

# PATHS ----

setwd("~/Documents/comp_mut/r_scripts/")

metadata_path <- "../../metadata/"
pipeline_db_path <- "../../pipeline/db/"
db_path <- "../../tbdb/"
results_path <- "../results/"

```

```{r files, echo = F, warning=F, message=F}

# FILES ----

# Metadata
metadata_file <- paste0(metadata_path, "tb_data_18_02_2021.csv")
# Database data
lineage_conversion_file <- paste0(pipeline_db_path, "lineage_conversions.txt")
dr_genes_file <- paste0(db_path, "tbdb.csv")
KCM_file <- paste0(pipeline_db_path, "compensatory_mutations.csv")

```

```{r isoniazid-files, echo = F, warning=F, message=F}

# Results
isoniazid_binary_table_file <- paste0(results_path, "isoniazid_binary_table.csv")
isoniazid_PCM_merged_file <- paste0(results_path, "isoniazid_PCM_merged.csv")
isoniazid_summary_file <- paste0(results_path, "isoniazid_summary.csv")
isoniazid_PRM_stats_file <- paste0(results_path, "isoniazid_PRM_stats.csv")
isoniazid_tree_file <- paste0(results_path, "isoniazid_tree.png")

```

```{r rifampicin-files, echo = F, warning=F, message=F}

rifampicin_binary_table_file <- paste0(results_path, "rifampicin_binary_table.csv")
rifampicin_PCM_merged_file <- paste0(results_path, "rifampicin_PCM_merged.csv")
rifampicin_summary_file <- paste0(results_path, "rifampicin_summary.csv")
rifampicin_tree_file <- paste0(results_path, "rifampicin_tree.png")

```

```{r read-in-data, echo = F, warning=F, message=F}

# READ IN DATA ----

# Metadata
metadata <- read.csv(metadata_file)
# Database data
lineage_conversions <- read.delim(lineage_conversion_file)
# dr_genes <- read.delim(dr_genes_file, header = F)
dr_genes <- read.csv(dr_genes_file)
KCM <- read.csv(KCM_file)

```

```{r isoniazid-read-in-data, echo = F, warning=F, message=F}

isoniazid_binary_table <- read.csv(isoniazid_binary_table_file)
isoniazid_PCM_merged <- read.csv(isoniazid_PCM_merged_file)
isoniazid_summary <- read.csv(isoniazid_summary_file)
isoniazid_PRM_stats <- read.csv(isoniazid_PRM_stats_file)

```

```{r rifampicin-read-in-data, echo = F, warning=F, message=F}

rifampicin_binary_table <- read.csv(rifampicin_binary_table_file)
rifampicin_PCM_merged <- read.csv(rifampicin_PCM_merged_file)
rifampicin_summary <- read.csv(rifampicin_summary_file)

```

```{r isoniazid-clean-data, echo = F, warning=F, message=F}

# Remove all the "[]" present in the binary table caused by python's lists
isoniazid_binary_table <- clean_binary_table(isoniazid_binary_table)

# Split out the other_vars to make extra row per mutation
isoniazid_binary_split <- data.frame(isoniazid_binary_table %>%
  mutate(other_vars = strsplit(as.character(other_vars), "; ")) %>%
  unnest(other_vars))

# Make col for just the other_vars genes, stripping out the change
isoniazid_binary_split$other_vars_gene <- gsub("-.*", "", isoniazid_binary_split$other_vars)

# Subset KCM for isoniazid
isoniazid_KCM <- KCM[KCM[,"Gene"] == "ahpC", ]

# Remove the PCMs in the KCM
isoniazid_PCM_merged <- isoniazid_PCM_merged[!(isoniazid_PCM_merged$change %in% isoniazid_KCM$Mutation), ]

# Transpose summary
isoniazid_summary <- data.frame(n = t(isoniazid_summary))

# PRM stats
isoniazid_PRM_stats <- select(isoniazid_PRM_stats, gene_mutation, n_samps, dst_prop, dr_prop, n_lins)
isoniazid_PRM_stats <- sort_pos(isoniazid_PRM_stats, 'gene_mutation')

# names(isoniazid_PRM_stats) <- c("Gene-change", "n samps")







# names(isoniazid_PRM_statsisoniazid_PRM_stats

```

```{r rifampicin-clean-data, echo = F, warning=F, message=F}

# Remove all the "[]" present in the binary table caused by python's lists
rifampicin_binary_table <- clean_binary_table(rifampicin_binary_table)

# Split out the other_vars to make extra row per mutation
rifampicin_binary_split <- data.frame(rifampicin_binary_table %>%
  mutate(other_vars = strsplit(as.character(other_vars), "; ")) %>%
  unnest(other_vars))

# Make col for just the other_vars genes, stripping out the change
rifampicin_binary_split$other_vars_gene <- gsub("-.*", "", rifampicin_binary_split$other_vars)

# Subset KCM for rifampicin
rifampicin_KCM <- KCM[KCM[,"Gene"] == "ahpC", ]

# Remove the PCMs in the KCM
rifampicin_PCM_merged <- rifampicin_PCM_merged[!(rifampicin_PCM_merged$change %in% rifampicin_KCM$Mutation), ]

# Transpose summary
rifampicin_summary <- data.frame(n = t(rifampicin_summary))

```


## Abstract

## Introduction

## Results

RM = any resistance mutation;
KRM = known RM;
PRM = potential RM;
CM = any compensatory mutation;
KCM = known CM;
PCM = potential CM

##### Isoniazid and katG

**Summary:**

```{r isoniazid-summary-table, echo = F, warning=F}

# Summary

n_samps_CM_and_no_KRM_and_no_PRM <- isoniazid_summary["n_samps_CM_and_no_KRM_and_no_PRM", ]

# PRM subset and summary
isoniazid_PRM_tab <- subset(isoniazid_binary_table, !(is.na(PRM)))
isoniazid_PRM_summary <- pivot(isoniazid_PRM_tab, formula(PRM ~ 'n'))

```

`r knitr::kable(isoniazid_summary)`

The isoniazid PRMs:
`r knitr::kable(isoniazid_PRM_summary)`

**Rare isoniazid (katG) variants**

```{r isoniazid-rare-mutations, echo = F, warning=F}

rare_katg_table <- subset(isoniazid_binary_table, !(is.na(CM)) & is.na(KRM) & is.na(PRM) & !(is.na(katG)) )
n_samps_rare_katg <- nrow(rare_katg_table)
n_rare_katg <- length(uniq_col(rare_katg_table$katG))
rare_katg_cnts <- table(table(unlist(strsplit(rare_katg_table$katG, "; "))))

```

The `r n_samps_CM_and_no_KRM_and_no_PRM` samples with CM but no KRM and no PRM have many INH mutations just found in one or two of these samples (‘*rare INH mutations*’). 

e.g. Looking at TBProfiler - sample ERR1035291 has CM ahpC-c.-74G>A and missense katG-p.Thr394Pro, but this is the only sample with this *katG* mutation. 

`r n_samps_rare_katg`/`r n_samps_CM_and_no_KRM_and_no_PRM` of the samples with CM but no KRM and no PRM have any katG missense mutation, with `r n_rare_katg` distinct mutations.

Most of these occur only once or twice and were therefore filtered out.

<!-- The mutations occurring 3 or 4 times were only in one lineage so were also filtered -->

`r knitr::kable(rare_katg_cnts)`

**Samples with potential PRMs - co-occurrences of other mutations**

```{r isoniazid-fabG, echo = F, warning=F}

isoniazid_PRM_KRM <- pivot(isoniazid_PRM_tab, formula(KRM ~ 'n'))
# isoniazid_PRM_fabg <- pivot(isoniazid_PRM_tab, formula(fabG1 ~ 'n'))
isoniazid_PRM_other <- pivot(isoniazid_PRM_tab, formula(other_vars ~ 'n'))

isoniazid_PRM_KRM <- cbind('status' = rep('KRM', nrow(isoniazid_PRM_KRM)), isoniazid_PRM_KRM)
isoniazid_PRM_other <- cbind('status' = rep('unknown', nrow(isoniazid_PRM_other)), isoniazid_PRM_other)

isoniazid_PRM_KRM_other <- rbind_force(isoniazid_PRM_KRM, isoniazid_PRM_other)
isoniazid_PRM_KRM_other <- dplyr::rename(isoniazid_PRM_KRM_other, mutation = KRM)

```

KRM and unknown mutations co-occurring in samples with PRM:
`r knitr::kable(isoniazid_PRM_KRM_other)`

Comparison to Ser315Thr and Ser315Thr-KRM in other isoniazid resistance genes.

```{r isoniazid-Ser315Thr, echo = F, warning=F}

# total n samps with a Ser315Thr mutation:  6877
# n samples with p.Ser315Thr and a fabG1 DR mutation:  909
# n samples with p.Ser315Thr and no fabG1 DR mutations:  5968
# proportion:  0.132
# n samps with a p.Ser315Thr mutation and a comp mutation:  177
# proportion:  0.026

ser315thr_tab <- subset(isoniazid_binary_table, grepl("Ser315Thr", isoniazid_binary_table$KRM))

# Move ser315thr string to front e.g. fabG1-c.-15C>T; katG-p.Ser315Thr -> katG-p.Ser315Thr; fabG1-c.-15C>T
ser315thr_tab$KRM <- ifelse(grepl("; katG-p.Ser315Thr", ser315thr_tab$KRM), swap_str(ser315thr_tab$KRM), ser315thr_tab$KRM)
# Drop the specific change for the co-occurring gene - e.g. katG-p.Ser315Thr; fabG1-c.-15C>T ->  katG-p.Ser315Thr; fabG1
ser315thr_tab$KRM_2 <- drop_change(ser315thr_tab$KRM)
ser315thr_pivot <- pivot(ser315thr_tab, formula(KRM_2 ~ 'n'))
ser315thr_pivot <- dplyr::rename(ser315thr_pivot, mutation = KRM_2)

```

`r knitr::kable(ser315thr_pivot)`



##### Rifampicin

**Summary:**

```{r rifampicin-summary-table, echo = F, warning=F}

# Summary

n_samps_CM_and_no_KRM_and_no_PRM <- rifampicin_summary["n_samps_CM_and_no_KRM_and_no_PRM", ]

# PRM subset and summary
rifampicin_PRM_tab <- subset(rifampicin_binary_table, !(is.na(PRM)))
rifampicin_PRM_summary <- pivot(rifampicin_PRM_tab, formula(PRM ~ 'n'))

```

`r knitr::kable(rifampicin_summary)`

**Rare rifampicin variants**

```{r rifampicin-rare-mutations, echo = F, warning=F}

rifampicin_rare_table <- subset(rifampicin_binary_table, !(is.na(CM)) & is.na(KRM) & is.na(PRM) & (!(is.na(rpoC)) | !(is.na(rpoB))) )
n_samps_rare_rifampicin <- nrow(rifampicin_rare_table)
n_rare_rifampicin <- length(uniq_col(rifampicin_rare_table$other_vars))
rare_rifampicin_table <- table(unlist(strsplit(rifampicin_rare_table$other_vars, "; ")))

```

`r knitr::kable(rare_rifampicin_table)`



## Methods

**Sequence data and processing**


### Figures

```{r isoniazid-tree, echo=FALSE, out.width = "2000px", fig.cap="Tree of isoniazid samples with potential new katG mutations" }

knitr::include_graphics(isoniazid_tree_file)

```

### Tables



### References
































