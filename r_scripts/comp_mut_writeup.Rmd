---
title: "Compensatory mutations in *ahpC* reveal novel *katG* mutations implicated in isoniazid resistance in Mycobacterium tuberculosis"
output: 
  bookdown::word_document2: 
    fig_caption: yes
    table_caption: yes
    number_sections: no
mainfont: Calibri
fontsize: 10pt
bibliography: all_refs.bib
csl: biomed-central.csl
---

```{r setup, include=FALSE}

# SETUP ----

rm(list = ls())

knitr::opts_chunk$set(echo = F)
# options(scipen=1, digits=2)
options(scipen=999, digits = 3)
table_font_sz <- 8

```

```{r functions, echo = F}

source("https://raw.githubusercontent.com/GaryNapier/Packages_functions/master/Functions.R")

uniq_col <- function(x, split = "; "){
  unique(unlist(strsplit(x, split)))
}

```

```{r variables, echo = F}


# VARIABLES ----

id_col <- "wgs_id"
rnd <- 3
drugs <- c("rifampicin", "isoniazid", "ethambutol", "pyrazinamide", "streptomycin", 
             "ofloxacin", "moxifloxacin", "levofloxacin", "amikacin", "kanamycin", "capreomycin", "ciprofloxacin", "prothionamide", 
             "ethionamide", "para_aminosalicylic_acid", "cycloserine",
             "clarithromycin", "clofazimine", "bedaquiline", "linezolid", "rifabutin", "delamanid")
fq <- "fluoroquinolones, ofloxacin, levofloxacin, ciprofloxacin, moxifloxacin"
agc <- "capreomycin, streptomycin, amikacin, kanamycin, aminoglycosides"
align <- c("l", "r", "r")
blue_col <- "cornflowerblue"
plot_text_sz <- 0.5
main_cex <- 1.5
# dr_status_vect <- c("Sensitive", "Pre-MDR", "MDR", "Pre-XDR", "XDR", "Other")
dr_status_vect <- c("Sensitive", "Pre-MDR-TB", "HR-TB", "RR-TB", "MDR-TB", "Pre-XDR-TB", "XDR-TB", "Other")

```

```{r paths, echo = F}

# PATHS ----

setwd("~/Documents/comp_mut/r_scripts/")

metadata_path <- "../../metadata/"
pipeline_db_path <- "../../pipeline/db/"
db_path <- "../../tbdb/"
results_path <- "../results/"

```

```{r files, echo = F}

# FILES ----

# Metadata
metadata_file <- paste0(metadata_path, "tb_data_18_02_2021.csv")
# Database data
lineage_conversion_file <- paste0(pipeline_db_path, "lineage_conversions.txt")
dr_genes_file <- paste0(db_path, "tbdb.csv")
KCM_file <- paste0(pipeline_db_path, "compensatory_mutations.csv")

```

```{r isoniazid-files, echo = F}

# Results
isoniazid_binary_table_file <- paste0(results_path, "isoniazid_binary_table.csv")
isoniazid_PCM_merged_file <- paste0(results_path, "isoniazid_PCM_merged.csv")
isoniazid_summary_file <- paste0(results_path, "isoniazid_summary.csv")
isoniazid_tree_file <- paste0(results_path, "isoniazid_tree.png")

```

```{r read-in-data, echo = F, warning=F}

# READ IN DATA ----

# Metadata
metadata <- read.csv(metadata_file)
# Database data
lineage_conversions <- read.delim(lineage_conversion_file)
# dr_genes <- read.delim(dr_genes_file, header = F)
dr_genes <- read.csv(dr_genes_file)
KCM <- read.csv(KCM_file)

```

```{r isoniazid-read-in-data, echo = F, warning=F}

# Results
isoniazid_binary_table <- read.csv(isoniazid_binary_table_file)
isoniazid_PCM_merged <- read.csv(isoniazid_PCM_merged_file)
isoniazid_summary <- read.csv(isoniazid_summary_file)

```

```{r isoniazid-clean-data, echo = F, warning=F}

# Remove all the "[]" present in the binary table caused by python's lists
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){gsub("\\[\\]", NA, as.character(x))}))
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){ gsub("\\[||\\]", "", as.character(x)) }))
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){ gsub("\\), \\(", "; ", as.character(x)) }))
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){ gsub("\\', \\'", "-", as.character(x)) }))
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){ gsub("\\(||\\)", "", as.character(x)) }))
isoniazid_binary_table <- data.frame(apply(isoniazid_binary_table, 2, function(x){ gsub("\\'", "", as.character(x)) }))

# Subset KCM for isoniazid
isoniazid_KCM <- KCM[KCM[,"Gene"] == "ahpC", ]

# Remove the PCMs in the KCM
isoniazid_PCM_merged <- isoniazid_PCM_merged[!(isoniazid_PCM_merged$change %in% isoniazid_KCM$Mutation), ]

# Transpose summary
isoniazid_summary <- data.frame(n = t(isoniazid_summary))

```

## Abstract

## Introduction

## Results

RM = any resistance mutation;
KRM = known RM;
PRM = potential RM;
CM = any compensatory mutation;
KCM = known CM;
PCM = potential CM

##### Isoniazid and katG

**Summary:**



```{r isoniazid-summary-table, echo = F, warning=F}

# Summary
knitr::kable(isoniazid_summary)

n_samps_CM_and_no_KRM_and_no_PRM <- isoniazid_summary["n_samps_CM_and_no_KRM_and_no_PRM", ]

```

**Rare isoniazid (katG) variants**

```{r isoniazid-rare-mutations, echo = F, warning=F}

rare_katg_table <- subset(isoniazid_binary_table, !(is.na(CM)) & is.na(KRM) & is.na(PRM) & !(is.na(katG)) )
n_samps_rare_katg <- nrow(rare_katg_table)
n_rare_katg <- length(uniq_col(rare_katg_table$katG))
rare_katg_cnts <- table(table(unlist(strsplit(rare_katg_table$katG, "; "))))

```

The `r n_samps_CM_and_no_KRM_and_no_PRM` samples with CM but no KRM and no PRM have many INH mutations just found in one or two of these samples (‘*rare INH mutations*’). 

e.g. Looking at TBProfiler - sample ERR1035291 has CM ahpC-c.-74G>A and missense katG-p.Thr394Pro, but this is the only sample with this katG mutation. 

`r n_samps_rare_katg`/`r n_samps_CM_and_no_KRM_and_no_PRM` of the samples with CM but no KRM and no PRM have any katG missense mutation, with `r n_rare_katg` distinct mutations.

Most of these occur only once or twice and were therefore filtered out.

The mutations occurring 3 or 4 times were only in one lineage so were also filtered

`r knitr::kable(rare_katg_cnts)`

**Isoniazid - samples with potential new resistance mutations which also have fabG1 DR mutations**

```{r isoniazid-fabG, echo = F, warning=F}

isoniazid_PRM_tab <- subset(isoniazid_binary_table, !(is.na(PRM)))


x <- isoniazid_PRM_tab$KRM

grepl("fabG1", "fabG1-c.-15C>T", fixed = TRUE)

grepl("fabG1", x, fixed = TRUE)

knitr::kable(table(isoniazid_PRM_tab$KRM))

```

## Methods

**Sequence data and processing**


### Figures

```{r isoniazid-tree, echo=FALSE, out.width = "2000px", fig.cap="Tree of isoniazid samples with potential new katG mutations" }

knitr::include_graphics(isoniazid_tree_file)

```

### Tables



### References
































